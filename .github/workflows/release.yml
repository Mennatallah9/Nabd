name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v0.1.0)'
        required: true
        default: 'v0.0.0-test'

env:
  REGISTRY: docker.io
  IMAGE_NAME: mennahaggag/nabd

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Derive tag name
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF##*/}"
          else
            TAG_NAME="${{ github.event.inputs.version }}"
          fi
          TAG_NAME="${TAG_NAME//[[:space:]]/}" # strip whitespace
          echo "Using tag: '$TAG_NAME'"
          if [[ -z "$TAG_NAME" ]]; then
            echo "Tag is empty. Provide a version input like v0.1.0" >&2
            exit 1
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Validate tag format
        run: |
          TAG='${{ steps.vars.outputs.tag }}'
          if [[ ! $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9._-]+)?$ ]]; then
            echo "Tag '$TAG' is invalid. Expected pattern vMAJOR.MINOR.PATCH (optionally -prerelease). Examples: v1.2.3, v1.2.3-rc1" >&2
            exit 1

      - name: Setup environments (Node & Go)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build frontend
        working-directory: ./frontend
        env:
          CI: false
        run: |
          npm ci
          npm run build

      - name: Build backend binaries
        working-directory: ./backend
        run: |
          for TARGET in "linux:amd64:nabd-linux-amd64" "windows:amd64:nabd-windows-amd64.exe" "darwin:amd64:nabd-darwin-amd64"; do
            IFS=':' read -r GOOS GOARCH OUT <<<"$TARGET"
            echo "Building $OUT ($GOOS/$GOARCH)"
            GOOS=$GOOS GOARCH=$GOARCH CGO_ENABLED=0 go build -ldflags='-w -s' -o "$OUT" main.go
          done

      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push image (linux/amd64)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest

      - name: Prepare release assets
        run: |
          TAG=${{ steps.vars.outputs.tag }}
          mkdir -p release-assets
          cp -r frontend/build release-assets/frontend-build
          cp backend/nabd-linux-amd64 backend/nabd-windows-amd64.exe backend/nabd-darwin-amd64 release-assets/
          pushd release-assets
          chmod +x nabd-linux-amd64 nabd-darwin-amd64 || true
          tar -czf nabd-frontend-${TAG}.tar.gz frontend-build/
          tar -czf nabd-${TAG}-linux-amd64.tar.gz nabd-linux-amd64
          zip nabd-${TAG}-windows-amd64.zip nabd-windows-amd64.exe
          tar -czf nabd-${TAG}-darwin-amd64.tar.gz nabd-darwin-amd64
          mkdir -p nabd-${TAG}
          cp -r frontend-build nabd-${TAG}/web
          cp nabd-linux-amd64 nabd-${TAG}/nabd
          cp ../README.md ../LICENSE ../config.yaml.example nabd-${TAG}/
          mv nabd-${TAG}/config.yaml.example nabd-${TAG}/config.yaml
          tar -czf nabd-${TAG}-complete.tar.gz nabd-${TAG}/
          sha256sum *.tar.gz *.zip > checksums.txt
          popd

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: "Nabd ${{ steps.vars.outputs.tag }}"
          draft: false
          prerelease: ${{ contains(steps.vars.outputs.tag, '-') }}
          files: |
            release-assets/*.tar.gz
            release-assets/*.zip
            release-assets/checksums.txt
          body: |
            ## Nabd ${{ steps.vars.outputs.tag }}

            ### Features
            - Real-time Docker container monitoring
            - Auto-healing capabilities for unhealthy containers
            - Beautiful web dashboard with React frontend
            - JWT-based authentication
            - REST API for metrics and container management

            ### Installation

            #### Docker (Recommended)
            ```bash
            docker run -d --name nabd \
              -p 8080:8080 \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v nabd-data:/app/data \
              mennahaggag/nabd:${{ steps.vars.outputs.tag }}
            ```

            #### Binary Installation
            1. Download the appropriate binary for your platform
            2. Extract the archive
            3. Run `./nabd` (Linux/macOS) or `nabd.exe` (Windows)

            ### Docker Images
            - `mennahaggag/nabd:${{ steps.vars.outputs.tag }}`
            - `mennahaggag/nabd:latest`

      - name: Release notification
        run: |
          echo "‚úÖ Successfully released Nabd ${{ steps.vars.outputs.tag }}"
          echo "üê≥ Docker image: mennahaggag/nabd:${{ steps.vars.outputs.tag }}"
          echo "üì¶ Assets: https://github.com/${{ github.repository }}/releases/tag/${{ steps.vars.outputs.tag }}"